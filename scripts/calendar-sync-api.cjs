#!/usr/bin/env node

/**
 * Google Calendar Sync for Daily Planning (API Version)
 * Purpose: Convert daily time blocks into Google Calendar events using direct API
 * Usage: node scripts/calendar-sync-api.cjs [date] [--auto]
 * Dependencies: planning system data, Google Calendar API key
 */

const fs = require('fs');
const path = require('path');
const GoogleCalendarAPI = require('./google-calendar-api.cjs');

// Configuration
const PLANNING_DIR = path.join(__dirname, '..', 'planning');
const DATA_DIR = path.join(PLANNING_DIR, 'data');

function getSydneyDate(date = new Date()) {
    return new Date(date.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
}

function formatSydneyDateString(date = new Date()) {
    const sydneyDate = new Date(date.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
    return sydneyDate.toISOString().split('T')[0];
}

function getBlockTypeColor(type) {
    const colors = {
        'deep-work': '1',     // Blue
        'learning': '2',      // Green
        'admin': '6',        // Orange
        'review': '3'        // Purple
    };
    return colors[type] || '7';  // Default grey
}

function formatTimeForCalendar(date, timeStr) {
    // Create proper ISO datetime string with Sydney timezone
    const [hours, mins] = timeStr.split(':').map(Number);
    const dateObj = new Date(`${date}T${timeStr}:00`);
    
    // Format for Google Calendar API (ISO 8601)
    return `${date}T${timeStr}:00+11:00`;  // Sydney timezone offset (adjust for DST if needed)
}

function addMinutes(timeStr, minutes) {
    const [hours, mins] = timeStr.split(':').map(Number);
    const totalMins = hours * 60 + mins + minutes;
    const newHours = Math.floor(totalMins / 60);
    const newMins = totalMins % 60;
    return `${newHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')}`;
}

async function syncCalendarEvents(date, autoMode = false) {
    const planFile = path.join(DATA_DIR, `day-${date}.json`);
    
    if (!fs.existsSync(planFile)) {
        console.log(`âŒ No daily plan found for ${date}`);
        console.log(`   Create plan first with: node scripts/fractal-planner.cjs plan-day ${date}`);
        return;
    }

    const plan = JSON.parse(fs.readFileSync(planFile, 'utf8'));
    const timeBlocks = plan.timeBlocks || [];
    
    if (timeBlocks.length === 0) {
        console.log(`âŒ No time blocks found in plan for ${date}`);
        return;
    }

    console.log(`ğŸ“… Calendar Sync for ${date}`);
    console.log(`ğŸ• Timezone: Australia/Sydney`);
    console.log(`ğŸ“‹ Time Blocks: ${timeBlocks.length}`);
    console.log(`ğŸ”‘ Using: ${autoMode ? 'API Direct Mode' : 'Interactive Mode'}\n`);

    // Remove duplicates based on start time and activity
    const uniqueBlocks = timeBlocks.reduce((acc, block) => {
        const key = `${block.start}-${block.activity}`;
        if (!acc.some(b => `${b.start}-${b.activity}` === key)) {
            acc.push(block);
        }
        return acc;
    }, []);

    const api = new GoogleCalendarAPI();
    
    // Check if we have OAuth access token
    if (!api.accessToken) {
        if (autoMode) {
            console.log('âš ï¸ No OAuth2 access token found for automatic mode!');
            console.log('   Google Calendar API requires OAuth2 authentication.');
            console.log('');
            console.log('   Setup detected MCP tokens - they should work for MCP commands.');
            console.log('   For direct API automation, additional OAuth2 setup may be needed.');
            console.log('');
            console.log('   Falling back to MCP command mode...\n');
            autoMode = false;  // Fall back to manual mode
        }
    }

    if (autoMode) {
        console.log('ğŸš€ Creating calendar events automatically...\n');
        
        const createdEvents = [];
        for (const block of uniqueBlocks) {
            try {
                const startTime = formatTimeForCalendar(date, block.start);
                const endTime = formatTimeForCalendar(date, addMinutes(block.start, block.duration));
                
                const eventData = {
                    summary: `${block.activity} - Fractal Plan`,
                    description: `${block.activity}\n\nğŸ¯ Alignment: ${block.alignment}\nğŸ“‹ Type: ${block.type}\nâ±ï¸ Duration: ${block.duration} minutes\n\nğŸš€ Generated by Fractal Planning System`,
                    start: startTime,
                    end: endTime,
                    timeZone: 'Australia/Sydney',
                    colorId: getBlockTypeColor(block.type),
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'popup', minutes: 10 },
                            { method: 'popup', minutes: 2 }
                        ]
                    }
                };
                
                console.log(`ğŸ“ Creating: ${block.activity} (${block.start} - ${addMinutes(block.start, block.duration)})`);
                const result = await api.createEvent('primary', eventData);
                
                if (result && result.id) {
                    console.log(`   âœ… Created successfully! Event ID: ${result.id}`);
                    createdEvents.push({
                        ...block,
                        eventId: result.id,
                        htmlLink: result.htmlLink
                    });
                } else {
                    console.log(`   âš ï¸ Event created but no ID returned`);
                }
                
            } catch (error) {
                console.log(`   âŒ Failed: ${error.message}`);
            }
        }
        
        // Save sync results
        const syncData = {
            date,
            synced: new Date().toISOString(),
            mode: 'api-auto',
            eventsCreated: createdEvents.length,
            totalBlocks: uniqueBlocks.length,
            events: createdEvents
        };
        
        const syncFile = path.join(PLANNING_DIR, 'analytics', `calendar-sync-${date}.json`);
        fs.mkdirSync(path.dirname(syncFile), { recursive: true });
        fs.writeFileSync(syncFile, JSON.stringify(syncData, null, 2));
        
        console.log(`\nâœ¨ Summary:`);
        console.log(`   Created ${createdEvents.length} of ${uniqueBlocks.length} events`);
        console.log(`   ğŸ’¾ Sync data saved to: analytics/calendar-sync-${date}.json`);
        
        if (createdEvents.length > 0 && createdEvents[0].htmlLink) {
            console.log(`   ğŸ”— View in Calendar: ${createdEvents[0].htmlLink.split('/event')[0]}`);
        }
        
    } else {
        // Interactive mode - show MCP commands and manual details
        console.log('ğŸ”„ MCP Integration Commands:');
        console.log('   Copy and paste these commands in Claude Code:\n');

        uniqueBlocks.forEach((block, index) => {
            const startTime = formatTimeForCalendar(date, block.start);
            const endTime = formatTimeForCalendar(date, addMinutes(block.start, block.duration));
            const description = `${block.activity}\\n\\nğŸ¯ Alignment: ${block.alignment}\\nğŸ“‹ Type: ${block.type}\\nâ±ï¸ Duration: ${block.duration} minutes\\n\\nğŸš€ Generated by Fractal Planning System`;
            
            console.log(`# Event ${index + 1}: ${block.activity}`);
            console.log(`/mcp call google-calendar create_event '{"calendarId": "primary", "summary": "${block.activity} - Fractal Plan", "description": "${description}", "start": "${startTime}", "end": "${endTime}", "timeZone": "Australia/Sydney", "reminders": {"useDefault":false,"overrides":[{"method":"popup","minutes":10},{"method":"popup","minutes":2}]}, "colorId": "${getBlockTypeColor(block.type)}"}'`);
            console.log('');
        });

        console.log('\nğŸ“‹ Manual Calendar Entry Alternative:');
        console.log('   Use these details if MCP is not available:\n');
        
        uniqueBlocks.forEach((block, index) => {
            const startTime = formatTimeForCalendar(date, block.start);
            const endTime = formatTimeForCalendar(date, addMinutes(block.start, block.duration));
            
            console.log(`${index + 1}. ${block.activity}`);
            console.log(`   ğŸ“… Date: ${date}`);
            console.log(`   â° Time: ${block.start} - ${addMinutes(block.start, block.duration)} (Sydney)`);
            console.log(`   ğŸ¯ Purpose: ${block.alignment}`);
            console.log(`   ğŸ“‹ Type: ${block.type}`);
            console.log(`   ğŸ¨ Color ID: ${getBlockTypeColor(block.type)}`);
            console.log(`   ğŸ”” Reminders: 10min & 2min before`);
            console.log('');
        });
        
        console.log('ğŸ’¡ Setup OAuth2 for automatic creation:');
        console.log(`   1. Configure OAuth2 credentials`);
        console.log(`   2. Run: node scripts/calendar-sync-api.cjs ${date} --auto\n`);
        
        // Save sync preparation data
        const syncData = {
            date,
            prepared: new Date().toISOString(),
            mode: 'manual',
            blocks: uniqueBlocks.map(b => ({
                start: b.start,
                duration: b.duration,
                activity: b.activity,
                type: b.type,
                alignment: b.alignment,
                calendarStart: formatTimeForCalendar(date, b.start),
                calendarEnd: formatTimeForCalendar(date, addMinutes(b.start, b.duration))
            }))
        };
        
        const syncFile = path.join(PLANNING_DIR, 'analytics', `calendar-prep-${date}.json`);
        fs.mkdirSync(path.dirname(syncFile), { recursive: true });
        fs.writeFileSync(syncFile, JSON.stringify(syncData, null, 2));
        
        console.log(`ğŸ’¾ Preparation data saved to: analytics/calendar-prep-${date}.json`);
    }
    
    console.log(`\nğŸ¯ Next Steps:`);
    console.log(`   1. Check your Google Calendar for the events`);
    console.log(`   2. Run '/taskmaster-start' to begin daily execution`);
    console.log(`   3. Use '/taskmaster-block' to track time blocks`);
}

// Main execution
async function main() {
    const args = process.argv.slice(2);
    const date = args[0] && !args[0].startsWith('--') ? args[0] : formatSydneyDateString(getSydneyDate());
    const autoMode = args.includes('--auto');
    
    console.log(`ğŸ—“ï¸  Calendar Sync API - ${date}`);
    console.log(`ğŸŒ Timezone: Australia/Sydney`);
    console.log(`ğŸ”§ Mode: ${autoMode ? 'Automatic' : 'Interactive'}\n`);
    
    try {
        await syncCalendarEvents(date, autoMode);
    } catch (error) {
        console.error('âŒ Error during sync:', error.message);
        process.exit(1);
    }
}

main();